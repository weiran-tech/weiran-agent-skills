# PRD→HLD 漂移检测指南

## 为什么漂移检测是最高优先级？

在多 AI Agent 协同工作中，PRD 和 HLD 可能由：
- 不同的 AI session 生成
- 不同的上下文环境
- 不同的时间点

这导致 **隐性知识断裂**，容易产生漂移。人类工程师有「隐性记忆」可以自动对齐，但 AI Agent 没有。

**漂移的代价极其高昂**：
- 需求遗漏 → 功能缺失，晚期返工
- 需求膨胀 → 过度工程，资源浪费
- 需求曲解 → 做出来不是用户要的，推倒重来

因此，**漂移检测必须作为第一道门，在所有其他审查之前完成**。

---

## 四种漂移类型

### 1. 需求遗漏（最严重）

**定义**：PRD 中明确定义的需求，在 HLD 中没有对应的设计。

**检测方法**：
```
For each requirement in PRD:
    Search HLD for corresponding design
    If not found:
        Mark as "需求遗漏" (P0)
```

**常见表现**：
- PRD 的验收标准在 HLD 中无法验证
- PRD 的功能点在 HLD 中未提及
- PRD 的非功能需求被忽略

**示例**：
```
PRD: "系统应支持密码重置功能，用户可通过邮箱验证码重置密码"
HLD: （未提及密码重置相关设计）
→ 需求遗漏 (P0)
```

---

### 2. 需求膨胀

**定义**：HLD 中出现了 PRD 未定义的功能或设计。

**检测方法**：
```
For each feature/design in HLD:
    Search PRD for corresponding requirement
    If not found:
        Check if marked as "技术必要性"
        If not marked:
            Mark as "需求膨胀" (P1)
```

**需要区分**：
| 类型 | 是否允许 | 处理方式 |
|------|----------|----------|
| 无标注的额外功能 | ❌ 不允许 | P1 问题，要求删除或补 PRD |
| 标注为「技术必要性」的设计 | ⚠️ 需审查 | 验证必要性是否符合合规标准 |
| 纯技术实现细节 | ✅ 允许 | 属于 HLD 职责范围 |

**「技术必要性」合规标准**（需满足以下任一条件）：

| 标准 | 描述 | 有效示例 | 无效示例 |
|------|------|----------|----------|
| **实现依赖** | 无此设计则 PRD 功能无法实现 | 「认证功能需要 Token 刷新机制」| 「加个缓存更好」 |
| **安全合规** | 安全/合规强制要求 | 「PCI DSS 要求加密存储」| 「建议加密」 |
| **稳定性保障** | 无此设计系统不稳定 | 「异步处理需要 DLQ 防止消息丢失」| 「加 DLQ 更完善」 |
| **行业惯例** | 公认的工程最佳实践 | 「API 需要版本号以支持演进」| 「加版本号更规范」 |

**技术必要性标注格式要求**：
- HLD 中必须明确标注「技术必要性：[具体原因]」
- 必须说明与哪条 PRD 需求关联（如「为支持 REQ-001 的认证功能」）
- 无标注或标注不符合上述标准的，视为「需求膨胀」(P1)

**示例**：
```
PRD: "实现用户登录功能"
HLD: "设计用户登录、第三方 OAuth 登录、单点登录（SSO）"
→ OAuth 和 SSO 是需求膨胀（除非有技术必要性说明）
```

---

### 3. 需求曲解

**定义**：HLD 的设计偏离了 PRD 的原意，字面上可能覆盖，但实际理解有偏差。

**检测方法**：
```
For each mapping (PRD requirement → HLD design):
    Verify semantic alignment:
        - Does HLD design fulfill the PRD intent?
        - Does HLD design match PRD acceptance criteria?
        - Are there implicit assumptions that differ?
    If misaligned:
        Mark as "需求曲解" (P0)
```

**常见表现**：
- PRD 说「实时」，HLD 设计成「准实时（延迟 5 分钟）」
- PRD 说「支持」，HLD 设计成「部分支持」
- PRD 说「用户」，HLD 理解成「管理员」

**示例**：
```
PRD: "系统应支持实时消息推送"
HLD: "使用消息队列异步处理，延迟约 30 秒"
→ 需求曲解：「实时」被理解为「30 秒延迟」(P0)
```

---

### 4. 边界漂移

**定义**：HLD 改变了 PRD 定义的功能边界（范围、约束、限制）。

**检测方法**：
```
Compare PRD scope definition with HLD scope:
    - In-scope items alignment
    - Out-of-scope items alignment
    - Constraints alignment
    - Assumptions alignment
If any boundary changed:
    Mark as "边界漂移" (P1)
```

**常见表现**：
- PRD 说「不做 X」，HLD 设计了 X
- PRD 限制「最多 1000 用户」，HLD 设计成「无限制」
- PRD 假设「内网环境」，HLD 设计成「公网环境」

**示例**：
```
PRD: "本期不支持批量导入，单条录入即可"
HLD: "设计批量导入接口，支持 Excel 上传"
→ 边界漂移：超出本期范围 (P1)
```

---

## 漂移检测执行步骤

### Step 1: 检查 PRD 基线标注

**检查项**：
- [ ] HLD 是否标注了 PRD 基线版本？
- [ ] PRD 文件路径是否正确？
- [ ] PRD 是否为**最新批准基线**？（非草稿版本）

> **「最新批准基线」定义**：
> - 经过正式评审通过的 PRD 版本，而非仍在迭代中的草稿
> - **证据路径**：检查 PRD 元数据中的「状态」字段（如 Approved/Draft），或使用 AskUserQuestion 询问用户确认

**处理路径（先问后判）**：

| 情况 | 严重度 | 处理 |
|------|--------|------|
| HLD 未标注 PRD，但用户可提供 | **P1** | 继续审查，记录文档质量缺陷 |
| 用户确认无 PRD | **P0** | 停止审查 |
| PRD 为 Draft 或状态未知 | **P0** | 停止审查，要求 PRD 先通过评审 |

**Step 1.1: 如果 HLD 未标注 PRD 来源**：
1. **先使用 AskUserQuestion 询问用户 PRD 路径**
2. 如果用户提供了 PRD 路径 → **P1**（文档质量缺陷），继续审查
3. 如果用户确认「没有对应的 PRD」→ **P0 阻塞，停止审查**：
```
发现 P0 问题：HLD 无 PRD 基础
- 问题：经用户确认，本 HLD 无对应的 PRD 文档
- 风险：无法验证需求一致性，HLD 缺乏需求依据
- 建议：先完成 PRD 文档，再进行 HLD 设计
```

**Step 1.2: 验证 PRD 状态**：
- 检查 PRD 元数据中的「状态」字段（如无，使用 AskUserQuestion 询问用户）
- **PRD 为 Approved** → 继续审查
- **PRD 为 Draft 或状态未知** → **P0 阻塞，停止审查**：
```
发现 P0 问题：PRD 未通过评审
- 问题：PRD 状态为 Draft（或状态未知），非批准基线
- 风险：基于未定稿的 PRD 进行 HLD 审查，结论可能无效
- 建议：PRD 先通过 prd-reviewer 评审，获得准出后再审查 HLD
```

> ⚠️ **禁止行为**：不得自行假设「HLD 没标注 PRD = 没有 PRD」，必须先询问用户

### Step 2: 检查需求映射表

**检查项**：
- [ ] HLD 是否包含 PRD↔HLD 需求映射表？
- [ ] 映射表格式是否完整（PRD 需求 ID、描述、HLD 章节）？

**期望的映射表格式**：
```markdown
| PRD 需求 ID | PRD 需求描述 | HLD 覆盖章节 | 覆盖程度 |
|-------------|--------------|--------------|----------|
| REQ-001 | 用户登录 | 3.1 认证设计 | 完全覆盖 |
| REQ-002 | 密码重置 | 3.2 密码管理 | 完全覆盖 |
| REQ-003 | 会话超时 | 3.3 会话管理 | 部分覆盖 |
```

**如果缺少映射表**：
```
发现 P0 问题：HLD 缺少 PRD↔HLD 需求映射表
- 问题：无法系统性验证需求覆盖情况
- 建议：补充需求映射表，逐条对应 PRD 需求
```

### Step 3: 逐条验证需求覆盖

**执行方法**：

1. **提取 PRD 需求清单**
   - 功能需求（用户故事、功能点）
   - 非功能需求（性能、安全、可用性）
   - 验收标准
   - 约束和假设

2. **逐条在 HLD 中查找**
   ```
   For each PRD_requirement:
       Search HLD for coverage
       Record: {
           prd_id: "REQ-001",
           prd_description: "...",
           hld_section: "3.1" or "未找到",
           coverage: "完全覆盖" | "部分覆盖" | "未覆盖",
           evidence: "HLD:L45-60" or "N/A"
       }
   ```

3. **标记问题**
   - 未覆盖 → 需求遗漏 (P0)
   - 部分覆盖 → 需进一步分析是否可接受

### Step 4: 反向检查需求膨胀

**执行方法**：

1. **提取 HLD 功能设计清单**
   - 所有功能模块
   - 所有接口设计
   - 所有数据设计

2. **逐条在 PRD 中查找来源**
   ```
   For each HLD_feature:
       Search PRD for source requirement
       If not found:
           Check if marked as "技术必要性"
           Record as potential drift
   ```

3. **分类处理**
   - 有 PRD 来源 → OK
   - 标注技术必要性 → 验证必要性
   - 无来源无标注 → 需求膨胀 (P1)

### Step 5: 语义对齐验证

**对于映射存在的需求，验证语义是否对齐**：

| 验证项 | 检查内容 |
|--------|----------|
| 功能完整性 | HLD 设计是否完整实现 PRD 功能？ |
| 性能对齐 | HLD 性能目标是否匹配 PRD 要求？ |
| 边界对齐 | HLD 范围是否在 PRD 边界内？ |
| 验收可测 | HLD 设计能否验证 PRD 验收标准？ |

---

## 漂移检测输出模板

```markdown
## PRD↔HLD 一致性检查报告

### 基本信息
- **PRD 基线**：[文件路径] v[版本号] ([日期])
- **HLD 文档**：[文件路径]
- **检查时间**：YYYY-MM-DD HH:MM

### 检查结果摘要
- PRD 需求总数：X 条
- 完全覆盖：Y 条 (Y/X = %)
- 部分覆盖：Z 条
- 未覆盖：W 条 ⚠️
- 需求膨胀：V 处 ⚠️

### 需求覆盖详情

| PRD 条目 | HLD 覆盖位置 | 状态 | 非已覆盖说明 |
|----------|-------------|------|-------------|
| REQ-001 用户登录 | 3.1:L45 | ✅ 已覆盖 | — |
| REQ-002 密码重置 | — | ❌ 未覆盖 | HLD 无对应设计，需补充密码重置流程章节 |
| REQ-003 会话管理 | 3.2:L78 | ⚠️ 部分覆盖 | 仅覆盖创建会话，未覆盖 PRD 要求的「登出所有设备」功能 |
| REQ-004 第三方登录 | 3.5:L120 | ⚠️ 部分覆盖 | 膨胀点：PRD 未要求第三方登录，HLD 自行添加，需确认是否在范围内 |

**`非已覆盖说明` 填写规则**：
- ✅ 已覆盖 → 填 `—`
- ⚠️ 部分覆盖 → **必填**：说明哪部分未覆盖、缺了什么
- ❌ 未覆盖 → **必填**：说明遗漏内容、建议补充方向
- ❓ 待澄清 → **必填**：说明需要澄清的问题
- 发现 **膨胀点** → 在说明中标注 `膨胀点：{描述}`

### 漂移问题清单

#### P0 阻塞问题
| # | 类型 | 描述 | PRD 证据 | HLD 证据 |
|---|------|------|----------|----------|
| 1 | 需求遗漏 | REQ-002 密码重置无设计 | PRD:2.3 | - |
| 2 | 需求曲解 | REQ-005 「实时」被设计为 30s 延迟 | PRD:3.1 | HLD:4.2 |

#### P1 严重问题
| # | 类型 | 描述 | PRD 证据 | HLD 证据 |
|---|------|------|----------|----------|
| 1 | 需求膨胀 | 第三方登录未在 PRD 范围内 | - | HLD:3.5 |
| 2 | 边界漂移 | 支持范围超出 PRD 定义 | PRD:1.4 | HLD:2.1 |

### 门一结论（仅决定是否继续审查）

- [ ] ✅ 无 P0，可继续审查（门一准入）
- [ ] ❌ 存在 P0，阻塞（停止审查）

### 修复建议

1. **REQ-002 密码重置**
   - 问题：HLD 缺少对应设计
   - 建议：在 HLD 3.x 节补充密码重置设计

2. **REQ-005 实时性**
   - 问题：HLD 设计与 PRD 要求不符
   - 建议：与 PRD 作者确认「实时」定义，或修改 HLD 设计

3. **第三方登录**
   - 问题：HLD 设计超出 PRD 范围
   - 建议：删除此设计，或补充 PRD 需求
```

---

## 常见漂移场景与处理

### 场景 1：PRD 需求模糊，HLD 做了具体化

**示例**：
```
PRD: "系统应有良好的性能"
HLD: "接口响应时间 < 200ms，QPS > 1000"
```

**处理**：
- 这不是漂移，是 HLD 的正常职责
- 但应验证具体化是否合理
- 建议 HLD 标注「基于 PRD X.X 具体化」

### 场景 2：PRD 有多种理解，HLD 选择了一种

**示例**：
```
PRD: "支持用户导出数据"
HLD: "支持 CSV 格式导出"（未支持 Excel）
```

**处理**：
- 标记为「待澄清」
- 询问 PRD 作者原意
- 不直接判定为漂移

### 场景 3：HLD 发现 PRD 遗漏，补充了设计

**示例**：
```
PRD: 未提及错误处理
HLD: 设计了完整的错误处理机制
```

**处理**：
- 这是合理的技术补充
- HLD 应标注「技术必要性：PRD 未明确，但实现必需」
- 不算需求膨胀

### 场景 4：PRD 变更后 HLD 未同步

**示例**：
```
PRD v2: 新增了 REQ-010
HLD: 基于 PRD v1，缺少 REQ-010
```

**处理**：
- 这是 P0 问题
- HLD 必须基于最新 PRD 版本
- 要求 HLD 同步更新

---

## 自动化检测建议

对于大型项目，可以考虑半自动化检测：

1. **需求 ID 关联**
   - PRD 需求使用唯一 ID（REQ-001, REQ-002...）
   - HLD 设计引用 PRD ID
   - 工具可自动检查 ID 覆盖率

2. **关键词匹配**
   - 提取 PRD 关键功能词
   - 在 HLD 中搜索匹配
   - 未匹配的标记为待审查

3. **结构化模板**
   - PRD 和 HLD 使用结构化模板
   - 章节一一对应
   - 便于自动化对比

---

## 核心原则

1. **漂移检测优先于所有其他审查**
2. **没有证据不判定漂移，只标记待澄清**
3. **需求遗漏是最严重的漂移类型**
4. **合理的技术补充不是需求膨胀**
5. **PRD 基线版本必须明确**
