# 角色视角审查要点

本文档定义了第三道门「风险驱动的角色增量审查」中各专业角色的审查要点。

---

## 角色启用规则

**不是每个 HLD 都需要全部角色审查。根据风险特征按需启用：**

| 风险特征 | 启用角色 |
|----------|----------|
| 涉及敏感数据、认证、授权 | Security |
| 涉及数据迁移、Schema 变更 | DBA |
| 高并发、性能敏感场景 | SRE/Performance |
| 跨团队、跨系统依赖 | Architect |
| 复杂测试场景 | QA |

**基础审查（必选）**：Tech Lead + Senior Engineer（已在第二道门覆盖）

---

## Security 视角

### 触发条件
- HLD 涉及用户认证/授权
- HLD 涉及敏感数据（PII、支付、健康等）
- HLD 涉及外部系统集成
- HLD 涉及 API 暴露给外部

### 审查要点

#### 1. 认证设计
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 认证机制是否明确？ | 未说明使用什么认证方式 | P1 |
| 是否使用安全的认证协议？ | 使用明文密码传输 | P0 |
| 会话管理是否安全？ | 会话 ID 可预测 | P0 |
| Token 存储是否安全？ | Token 存储在 localStorage | P1 |
| 密码策略是否合理？ | 无密码复杂度要求 | P1 |

#### 2. 授权设计
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 权限模型是否明确？ | 未说明权限检查机制 | P1 |
| 是否有越权风险？ | 仅靠前端控制权限 | P0 |
| 是否遵循最小权限原则？ | 默认给予过高权限 | P1 |

#### 3. 数据保护
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 敏感数据是否加密存储？ | 密码明文存储 | P0 |
| 传输是否加密？ | 使用 HTTP 而非 HTTPS | P0 |
| 日志是否脱敏？ | 日志中包含完整手机号 | P1 |
| 数据是否有访问控制？ | 任何服务都能读取用户表 | P1 |

#### 4. 安全审计
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 关键操作是否有审计日志？ | 删除操作无日志 | P1 |
| 审计日志是否防篡改？ | 审计日志可被删除 | P1 |
| 异常行为是否有告警？ | 无登录失败告警 | P2 |

#### 5. 合规性
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 是否符合数据保护法规？ | 未考虑 GDPR 要求 | P1 |
| 是否有数据删除机制？ | 无法真正删除用户数据 | P1 |

### 典型问题示例

```markdown
**问题**：用户密码使用 MD5 哈希存储
**角色**：Security
**严重度**：P0
**证据**：HLD 4.2 节 "密码使用 MD5 加密存储"
**风险**：MD5 已不安全，容易被彩虹表破解
**建议**：使用 bcrypt 或 Argon2 进行密码哈希
```

---

## DBA 视角

### 触发条件
- HLD 涉及数据库 Schema 变更
- HLD 涉及数据迁移
- HLD 涉及大数据量处理
- HLD 涉及新建数据库/表

### 审查要点

#### 1. 数据模型设计
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 实体设计是否合理？ | 过度范式化导致查询复杂 | P2 |
| 关系设计是否正确？ | 多对多关系缺少中间表 | P1 |
| 是否考虑数据增长？ | 单表设计无法支撑亿级数据 | P1 |

#### 2. Schema 变更
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 变更是否向后兼容？ | 删除列导致旧版本报错 | P0 |
| 是否有迁移脚本？ | 只描述目标状态无迁移步骤 | P1 |
| 是否支持回滚？ | 数据迁移不可逆 | P0 |
| 是否考虑在线迁移？ | 迁移需要停服 | P1 |

#### 3. 数据迁移
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 迁移数据量评估？ | 未评估迁移时长 | P1 |
| 迁移失败如何处理？ | 无中断恢复机制 | P1 |
| 数据一致性如何保证？ | 迁移过程中数据可能不一致 | P1 |
| 是否有数据验证？ | 迁移后无校验步骤 | P1 |

#### 4. 索引设计
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 关键查询是否有索引支撑？ | 高频查询走全表扫描 | P1 |
| 索引是否过多？ | 写入性能下降 | P2 |
| 是否有无用索引？ | 存在从未使用的索引 | P2 |

#### 5. 性能考量
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 大表查询是否有优化？ | COUNT(*) 全表扫描 | P1 |
| 是否考虑分库分表？ | 单表超过 5000 万行 | P1 |
| 是否有慢查询风险？ | 复杂 JOIN 无优化 | P2 |

### 典型问题示例

```markdown
**问题**：用户表新增 NOT NULL 列，无默认值
**角色**：DBA
**严重度**：P0
**证据**：HLD 3.2 节 Schema 变更 "ALTER TABLE users ADD COLUMN phone VARCHAR(20) NOT NULL"
**风险**：现有数据无法满足 NOT NULL 约束，迁移会失败
**建议**：
1. 先添加列允许 NULL
2. 迁移数据填充默认值
3. 再修改为 NOT NULL
```

---

## SRE/Performance 视角

### 触发条件
- HLD 涉及高并发场景
- HLD 有明确的性能要求
- HLD 涉及关键业务路径
- HLD 涉及资源密集型操作

### 审查要点

#### 1. 性能目标
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 性能目标是否明确？ | 只说"快"，无具体指标 | P1 |
| 目标是否与 PRD 对齐？ | PRD 要求 100ms，HLD 设计 500ms | P0 |
| 是否有基线数据？ | 无法衡量性能是否达标 | P2 |

#### 2. 容量规划
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 是否有容量评估？ | 不知道能支撑多少 QPS | P1 |
| 是否考虑峰值场景？ | 只考虑平均负载 | P1 |
| 扩容方案是否明确？ | 无水平扩展设计 | P1 |

#### 3. 高可用设计
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 是否有单点故障？ | 核心服务无备份 | P0 |
| 是否有降级方案？ | 依赖不可用时系统挂掉 | P1 |
| 是否有熔断设计？ | 下游故障拖垮上游 | P1 |
| 是否有限流设计？ | 突发流量打垮系统 | P1 |

#### 4. 故障恢复
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 故障检测是否及时？ | 故障 10 分钟后才发现 | P1 |
| 恢复步骤是否明确？ | 没有故障恢复 SOP | P1 |
| 数据恢复能力如何？ | 无法恢复到故障前状态 | P1 |

#### 5. 运维友好性
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 是否便于问题定位？ | 日志不足以定位问题 | P2 |
| 是否便于配置变更？ | 改配置需要重启服务 | P2 |
| 是否便于版本管理？ | 无法快速识别运行版本 | P2 |

### 典型问题示例

```markdown
**问题**：缓存失效时直接穿透到数据库
**角色**：SRE
**严重度**：P1
**证据**：HLD 5.1 节缓存设计，未提及缓存击穿保护
**风险**：热点 key 失效时可能打垮数据库
**建议**：
1. 使用互斥锁防止缓存击穿
2. 设置热点 key 永不过期
3. 增加本地缓存作为二级保护
```

---

## Architect 视角

### 触发条件
- HLD 涉及跨团队依赖
- HLD 涉及跨系统集成
- HLD 涉及架构重大变更
- HLD 影响多个现有系统

### 审查要点

#### 1. 架构一致性
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 是否符合企业架构原则？ | 违反微服务边界原则 | P1 |
| 是否与现有系统设计一致？ | 与其他服务风格迥异 | P2 |
| 是否遵循既定模式？ | 重新发明已有解决方案 | P1 |

#### 2. 系统边界
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 系统边界是否清晰？ | 职责与其他系统重叠 | P1 |
| 是否有循环依赖？ | A 依赖 B，B 依赖 A | P0 |
| 依赖方向是否合理？ | 核心服务依赖边缘服务 | P1 |

#### 3. 跨系统影响
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 对上游系统的影响？ | 需要上游配合改造 | P1 |
| 对下游系统的影响？ | 下游需要适配新接口 | P1 |
| 接口契约是否明确？ | 接口定义不清晰 | P1 |

#### 4. 演进性
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 是否便于后续扩展？ | 设计过于定制化 | P2 |
| 是否便于独立部署？ | 多个模块紧耦合 | P1 |
| 是否便于独立演进？ | 改动影响范围过大 | P2 |

### 典型问题示例

```markdown
**问题**：新服务直接访问其他团队的数据库
**角色**：Architect
**严重度**：P0
**证据**：HLD 3.3 节 "直接查询用户中心数据库获取用户信息"
**风险**：违反服务边界原则，数据库变更会直接影响本服务
**建议**：通过用户中心提供的 API 获取用户信息，而非直接访问数据库
```

---

## QA 视角

### 触发条件
- HLD 涉及复杂业务逻辑
- HLD 涉及多系统集成
- HLD 涉及状态机/流程
- HLD 测试难度较高

### 审查要点

#### 1. 可测试性
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 模块是否便于单测？ | 模块间强耦合 | P2 |
| 是否便于 Mock？ | 外部依赖无法模拟 | P1 |
| 是否有测试困难点？ | 某些场景难以构造 | P1 |

#### 2. 测试策略
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 单元测试策略是否可行？ | 代码难以单元测试 | P2 |
| 集成测试策略是否可行？ | 依赖环境难以搭建 | P1 |
| E2E 测试策略是否可行？ | 测试场景过于复杂 | P2 |

#### 3. 测试数据
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| 测试数据如何准备？ | 无法构造测试数据 | P1 |
| 测试环境如何隔离？ | 测试会污染其他数据 | P1 |

#### 4. 验收标准
| 检查项 | 问题 | 严重度 |
|--------|------|--------|
| HLD 能否验证 PRD 验收标准？ | 部分验收标准无法测试 | P1 |
| 性能验收如何进行？ | 无性能测试方案 | P2 |

### 典型问题示例

```markdown
**问题**：异步消息处理无法验证消息是否正确消费
**角色**：QA
**严重度**：P1
**证据**：HLD 4.5 节消息队列设计
**风险**：消息消费失败可能无法及时发现，测试覆盖困难
**建议**：
1. 增加消费状态查询接口
2. 增加消费失败告警
3. 提供测试工具模拟消息
```

---

## 角色审查输出模板

```markdown
## [角色名] 视角审查结果

### 触发条件
- [列出触发审查的风险特征]

### 审查发现

#### P0 阻塞问题
| # | 问题描述 | 证据位置 | 风险 | 建议 |
|---|----------|----------|------|------|
| 1 | [描述] | HLD:X.X | [风险] | [建议] |

#### P1 严重问题
| # | 问题描述 | 证据位置 | 风险 | 建议 |
|---|----------|----------|------|------|
| 1 | [描述] | HLD:X.X | [风险] | [建议] |

#### P2 建议
| # | 问题描述 | 证据位置 | 建议 |
|---|----------|----------|------|
| 1 | [描述] | HLD:X.X | [建议] |

### 待澄清问题
- [ ] [需要 HLD 作者或相关方澄清的问题]

### 角色审查结论
- [ ] ✅ 通过（无 P0/P1）
- [ ] ❌ 不通过（存在 P0/P1）
```
